# NCCL：调试与性能优化笔记

关于如何调试基于NCCL的软件以及如何将其性能调优至最佳状态的指南。

## NCCL环境变量

完整的列表可以在[这里](https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html)找到，但其中许多变量已经不再使用。以下是一些在调试NCCL相关问题时最有用的变量：

### 调试相关的环境变量

以下环境变量对于调试诸如挂起和崩溃等NCCL相关问题非常有用：

#### `NCCL_DEBUG`

这是最常用于调试网络问题的环境变量。它的值可以是：
- `VERSION`: 在程序启动时打印NCCL版本信息。
- `WARN`: 当任何NCCL调用发生错误时，打印明确的警告消息。
- `INFO`: 输出调试信息。
- `TRACE`: 输出可重放的跟踪信息，包括每个调用的详细信息。

例如：
```bash
NCCL_DEBUG=INFO python -m torch.distributed.run --nproc_per_node 2 --nnodes 1 torch-distributed-gpu-test.py
```
这将产生大量的NCCL相关的调试信息，您可以通过在线搜索这些信息来查找可能的问题报告。此外，结合使用`NCCL_DEBUG_FILE`可以更有效地处理大量日志信息。

#### `NCCL_DEBUG_FILE`

当使用`NCCL_DEBUG`环境变量时，将所有NCCL调试日志输出重定向到文件中。默认情况下，日志会输出到标准输出（`stdout`）。如果使用了多个GPU，那么保存每个进程的调试信息到单独的日志文件中是非常有帮助的，这可以通过设置如下环境变量来实现：
```
NCCL_DEBUG_FILE=/path/to/nccl-log.%h.%p.txt
```
在这个命令中：
- `%h`会被替换为主机名；
- `%p`会被替换为进程的PID。

如果您需要分析数百个这样的日志文件，可以使用以下有用的小技巧：
- 通过特定的匹配项进行搜索并同时打印出该匹配是在哪个文件和哪一行被发现的：
```
grep -n "Init COMPLETE" nccl-log*
```
- 显示所有`nccl*`日志文件的末尾行，并跟随每条记录对应的文件名：
```
find . -name "nccl*" -exec sh -c 'echo "$(tail -1 "$1") ($1)"' _ {} \;
```
#### `NCCL_DEBUG_SUBSYSTEM`

`NCCL_DEBUG_SUBSYSTEM`与`NCCL_DEBUG`一起使用，用来指定哪些子系统应该被显示。通常不需要显式地设置这个变量，但是有时开发人员可能会要求限制输出以仅包含某些子系统的信息，例如：
```
NCCL_DEBUG_SUBSYSTEM=INIT,GRAPH,ENV,TUNING
```
#### `NCCL_P2P_DISABLE`

禁用点对点通信——即使存在NVLink，也不会使用它。这将导致性能显著下降。

#### `NCCL_SOCKET_IFNAME`

如果您有多张网卡并且想要选择特定的一张用于通信，这个环境变量就非常实用了。默认情况下，NCCL会尝试使用最快类型的接口，通常是`ib`（Infiniband）。但如果您想使用以太网接口，您可以覆盖此行为：
```
NCCL_SOCKET_IFNAME=eth
```
这个环境变量在遇到网络连接性问题时也很有用，比如某个接口被防火墙阻止而其他未受影响的情况，或者不确定问题是来自网络接口还是其他地方的情况下，测试其他接口可以帮助排除网络方面的可能性。

### 与性能相关的环境变量

以下环境变量主要用于调整性能：

#### `NCCL_ALGO`

这个变量定义了NCCL使用的算法。通常可以选择的有：
1. 树形结构（Tree）；
2. 环形结构（Ring）；
3. 聚合直接和链式（IB SHARP）；
4. NVIDIA Link Speed（NVLink SHARP）（新）。

我之前询问过用户是否能够自行优化，得到的回答是NCCL内部拥有众多智能算法，它们会在不同场景下自动切换以达到最优性能，因此用户无需手动干预。开发者建议不要试图优化任何东西，因为NCCL已经在很大程度上实现了自适应和高效。

Sylvain Jeaugey分享了一些见解：
> 曾经有一个静态阈值，但它已经被一个更加复杂的调优系统所取代。新的系统构建了一个模型，根据大小预测每种算法/协议组合的延迟和带宽。然后决定哪种算法应该在给定的大小下表现最好。所以现在没有固定的环境变量和一个静态值，这对于跨所有平台和用户的最佳性能来说是一个更好的解决方案。缺点是你不能手动调优，如果你想这样做，你做不到。